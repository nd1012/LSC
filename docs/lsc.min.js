"undefined"==typeof window.LSC&&(window.LSC=async(a,b,c)=>{var d=Math.floor;if("undefined"!=typeof window.LSC&&LSC.instance){const c=LSC.instance;if("undefined"!=typeof a&&a!=c.getKey())throw new Error("Can not change LSC cache key");return b&&b>c.getCacheVersion()&&(console.debug("Initialize newer LSC cache version",b),c.clear(b),await c.get(window.location.href)),c}const f=LSC.instance=this,g=new RegExp("^[^:]+://"+document.location.hostname.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"(/.*)?$","i"),h=/^.+\.([^\.|\/]+)$/;("undefined"==typeof a||null==a)&&(a=document.location.hostname);var i="string"==typeof(LSC.options.useSessionStorage?sessionStorage:localStorage).getItem(a)?new Map(JSON.parse((LSC.options.useSessionStorage?sessionStorage:localStorage).getItem(a))):null,j=0,k=LSC.options.useSessionStorage,l=new Map;const m=async a=>(console.debug("LSC handle link click",a),LSC.options.enable?void((await f.navigate(a.target.href))?a.preventDefault():console.warn("LSC failed to navigate",a)):void console.debug("LSC disabled")),n=a=>{for(let b in LSC.excluded)if(b instanceof RegEx){if(b.test(a))return!0;}else if(a.substring(0,b.length)==b)return!0;return!1},o=a=>{for(let b in LSC.included)if(b instanceof RegEx){if(b.test(a))return!0;}else if(a.substring(0,b.length)==b)return!0;return!1},p=()=>{if(!LSC.extensions.length)return[];const b=document.querySelector("html"),d=LSC.extensions,i=[];let j;for(let[,k]of document.querySelectorAll(LSC.selector).entries())(o(j.href)||0>k.href.indexOf("?")&&0>k.href.indexOf("#")&&g.test(k.href)&&(/\/$/.test(k.href)||h.test(k.href)&&-1<d.indexOf(k.href.replace(h,"$1")))&&!n(k.href))&&(console.debug("Manage link",k.href,k),j=new CustomEvent("beforemanage",{detail:{link:k,manage:!0,preFetch:!0}}),LSC.events.dispatchEvent(j),j.detail.manage?(k.addEventListener("click",m),k.setAttribute("data-lscmanaged",null),i.push(k)):console.debug("Event handler disabled LSC link management",k),j.detail.preFetch?(!LSC.options.maxEntries||LSC.options.maxEntries>i.length)&&(c||b.hasAttribute("data-prefetch")||k.hasAttribute("data-prefetch"))&&!b.hasAttribute("data-noprefetch")&&!k.hasAttribute("data-noprefetch")&&(k.setAttribute("data-lscprefetched",null),f.get(k.href)):console.debug("Event handler disabled LSC pre-fetching",k));return LSC.events.dispatchEvent(new CustomEvent("manage",{detail:{html:b,extensions:d,managed:i}})),i};return this.getCache=()=>i,this.getKey=()=>a,this.getCacheVersion=()=>i.get("version"),this.getHistoryIndex=()=>j,this.getSessionStorage=()=>seessionStorage,this.setSessionStorage=b=>b==k?f:(k=b,k&&null!=localStorage.getItem(a)&&localStorage.removeItem(a),f.store(!0),f),this.navigate=async(a,b,c)=>{console.debug("LSC navigate to \""+a+"\"",b,c);const d=document.location.href,g="undefined"!=typeof c,h=await f.get(a,!0);if(null==h)return console.warn("LSC got no HTML for URI \""+a+"\"",b,c,d),!1;if(LSC.events.dispatchEvent(new CustomEvent("beforenavigate",{detail:{uri:a,noState:b,oldUri:d,history:j}})),LSC.options.history?(document.querySelector("html").innerHTML=h,scrollTo(0,0),b?(j||g)&&(g?j=c:j--):(g?j=c:j++,history.pushState("LSC"+j,document.title,a))):(j=0,document.write(h),document.close()),p(),LSC.options.history){const a=document.querySelector("body");a&&a.hasAttribute("onload")&&new Function("event",a.getAttribute("onload"))(new Event("load"))}return LSC.events.dispatchEvent(new CustomEvent("navigated",{detail:{uri:a,noState:b,oldUri:d,history:j}})),!0},this.update=async(a,b,c)=>{if(console.debug("Update LSC cache for \""+a+"\"",b,c),!b&&l.has(a))return console.debug("LSC avoid double-fetching \""+a+"\""),await l.get(a),i.get(a);var d=!1;if(!b&&l.size>=LSC.options.maxConcurrentFetch){for(console.debug("Waiting for running concurrent LSC fetch-actions to finish ("+l.size+")",l),d=!0;l.size>=LSC.options.maxConcurrentFetch;await l.entries().next().value[1]);console.debug("Continue updating LSC cache for \""+a+"\"")}var f=null;b||l.set(a,new Promise(a=>f=a));try{const d=await fetch(a),f=d.headers.get("Content-Type").trim(),g=f.toLowerCase(),h="text/html"==g.substring(0,9)||"application/xhtml+xml"==g.substring(0,21);if(html=await d.text(),e=new CustomEvent("update",{detail:{uri:a,html:html,response:d,priority:!!b,ignoreMime:!!c}}),!h&&!c){console.warn("LSC received an invalid response MIME type for \""+a+"\"",a,g,d,e);let h=new CustomEvent("invalid",{detail:{uri:a,html:html,contentType:f,response:d,cancel:!1,priority:!!b,ignoreMime:!!c}});debugger;if(LSC.events.dispatchEvent(h),h.detail.cancel)return console.debug("Invalid MIME type response handling from \""+a+"\" has been disabled by LSC event handler",h),i.get(a)}if(LSC.events.dispatchEvent(e),"string"!=typeof e.detail.html){console.warn("LSC failed to fetch HTML from \""+a+"\"",e),LSC.events.dispatchEvent(new CustomEvent("error",{detail:{uri:a,html:e.detail.html}}));debugger;return i.get(a)}if(i.set(a,e.detail.html),LSC.options.maxEntries&&i.size>LSC.options.maxEntries+1){let a=i.keys();a.next(),i.delete(a.next().value)}return LSC.events.dispatchEvent(new CustomEvent("updated",{detail:{uri:a,html:e.detail.html,priority:!!b,ignoreMime:!!c}})),e.detail.html}catch(b){console.error("Error updating LSC cache for \""+a+"\"",b);debugger;return i.get(a)}finally{b||(f(),l.delete(a),d&&console.debug("Finished updating LSC cache for \""+a+"\""))}},this.get=async(a,b,c)=>i.has(a)?i.get(a):await f.update(a,b,c),this.clear=a=>(LSC.options.quiet||console.trace("Clear LSC cache",a),i?i.clear():i=new Map,i.set("version",a?+a:d(Date.now()/1e3)),LSC.events.dispatchEvent(new CustomEvent("clear",{detail:{cache:i,version:a}})),f.store(!0)),this.store=b=>{try{LSC.options.quiet||console.trace("Store LSC cache",b),LSC.events.dispatchEvent(new CustomEvent("store",{detail:{cache:i}})),(k?sessionStorage:localStorage).setItem(a,JSON.stringify(Array.from(i.entries())))}catch(a){if(b){console.error("Failed to store the LSC cache",a);debugger}else console.error("Failed to store the LSC cache - initializing",a),f.clear(i.get("version"))}return i},LSC.options.quiet||console.log("LSC initializing",a,b,c),(!i||b&&i.get("version")<+b)&&this.clear(b),document.body.addEventListener("beforeunload",this.store),history.replaceState("LSC0",document.title,document.location.href),await this.get(document.location.href),window.addEventListener("popstate",async a=>{if(!LSC.options.history)return;const b=window.location.href,c=parseInt(a.state.substring(3)),d=c<j;if(console.debug("LSC history (#"+c+") navigation "+(d?"back":"forward")+" to \""+b+"\"",a),a.preventDefault(),!(await f.navigate(b,!0,c))){console.warn("LSC failed to navigate to \""+b+"\" - fallback to real browser relocation",a);debugger;return void(document.location.href=b)}setTimeout(()=>LSC.events.dispatchEvent(new CustomEvent("history",{detail:{uri:b,index:c,back:d}})),0)}),p(),LSC.events.dispatchEvent(new Event("load")),this},LSC.instance=null,LSC.events=new EventTarget,LSC.selector="a:not([target]):not([onclick]):not([data-lscunmanaged]),a[data-lscmanaged]",LSC.extensions=["html","htm","php"],LSC.exclude=[],LSC.include=[],LSC.options={enable:!0,quiet:!1,history:!0,useSessionStorage:!1,maxEntries:0,maxConcurrentFetch:5});